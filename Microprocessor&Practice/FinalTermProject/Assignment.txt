#include <avr/io.h>
#include <util/delay.h>

#define IGNORE 50 //조이스틱 중앙의 무시할 값

#define PULSE_INIT 1400  // 모터 초기화
#define PULSE_120 3600   // 1번 모터 120도
#define PULSE_45 2000    // 2번 모터 45도
#define PULSE_75 3000    // 3번 모터 60도

void PWM_init(){
    //고속 PWM, 비반전, 1번 타이머 3개 세팅(COM1A1, B1, C1)
    TCCR1A |= (1 << WGM11) | (1 << COM1A1) | (1 << COM1B1) | (1 << COM1C1); 

    TCCR1B |= (1 << WGM12) | (1 << WGM13) | (1 << CS11);    //분주율 8
    ICR1 = 39999; //20ms 주기
}

void ADC_init(){
    ADMUX |= (1 << REFS0); //AVCC 기준 전압
    ADCSRA |= (1 << ADEN) | (1 << ADPS2) | (1 << ADPS1) | (1 << ADPS0); //ADC 활성화, 프리스케일러 128
}

uint16_t ADC_read(uint8_t channel) {
    ADMUX = (ADMUX & 0xF8) | (channel & 0x07); //입력 채널 선택, 하위 3비트 채널 설정

    ADCSRA |= (1 << ADSC); //ADC 변환 시작

    while (ADCSRA & (1 << ADSC)); //ADC 변환 완료 대기

    return ADC; //변환 결과 반환
}
int main(){
    DDRB |= (1 << PB5) | (1 << PB6) | (1 << PB7); //모터1, 2, 3(아두이노 11, 12, 13)
    DDRD &= ~(1 << PD2); //초록버튼 모터 제어(아두이노 19)
    DDRD &= ~(1 << PD3); //파랑버튼 LED 제어(아두이노 18)
    DDRH &= ~(1 << PH5); //조이스틱 스위치(아두이노 8)

    PORTD |= (1 << PD2) | (1 << PD3); //스위치 2개 풀업 저항(초록, 파랑)
    PORTH |= (1 << PH5);              //조이스틱 스위치 풀업 저항

    DDRE |= (1 << PE3); //LED 출력(아두이노 5)

    PWM_init(); //PWM 초기화
    ADC_init(); //ADC 초기화

    bool degree60 = false; //3번 모터 0인가 60인가
    bool ledOn = false;    //LDE 상태 켜져있는가 꺼져있는가


    //모든 모터 0도 초기화
    OCR1A = PULSE_INIT;
    OCR1B = PULSE_INIT;
    OCR1C = PULSE_INIT;
while(1){

        uint16_t x = ADC_read(0); // 조이스틱 X축 값 읽기
        int16_t dx = x - 512; // 중앙값과 차이 계산
        uint16_t y = ADC_read(1); // 조이스틱 Y축 값 읽기
        int16_t dy = y - 512; // 중앙값과 차이 계산

        //조이스틱 x축 이동 제어
        //1번 모터, 조이스틱의 가운데 무시할 값보다 dx가 커야함, 가운데 미세한 값은 무시한다는 뜻
        if(dx > IGNORE) OCR1A = PULSE_INIT; //왼쪽 -> 0도
        else if(dx < -IGNORE) OCR1A = PULSE_120; //오른쪽 -> 120도

        //2번 모터, 조이스틱 y축 제어
        if(dy > IGNORE) OCR1B = PULSE_INIT; //위 -> 0도
        else if(dy < -IGNORE) OCR1B =  PULSE_45; //아래 -> 45도

        //3번 모터, 버튼 누르면 공 집을 수 있도록
        if(!(PIND & (1 << PD2))){ //버튼이 눌렸는가?
            _delay_ms(50); // 디바운싱
            if(!(PIND & (1 << PD2))){ //버튼이 여전히 눌림?
                degree60 = !degree60; //60도로 설정하자
                OCR1C = degree60 ? PULSE_75 : PULSE_INIT; //60도면 0도 0도면 60도
                while(!(PIND & (1 << PD2))); //떼질 때까지 기다리기
            }
        }
//LED 제어(추가 기능)
        if(!(PIND & (1 << PD3))){//버튼 눌림?
            _delay_ms(50); // 디바운싱
            if(!(PIND & (1 << PD3))){//버튼이 여전히 눌림?
                ledOn = !ledOn; // LED 상태 전환
                if(ledOn) PORTE |= (1 << PE3); // LED 켜기
                else PORTE &= ~(1 << PE3); // LED 끄기
                while (!(PIND & (1 << PD3))); //떼질 때까지 기다리기
            }
        }

        //조이스틱 스위치로 모터 위치 반전
        if(!(PINH & (1 << PH5))){ //조이스틱 버튼 눌렸는가?
            _delay_ms(50); //디바운싱
            if(!(PINH & (1 << PH5))){ // 버튼이 여전히 눌려 있다면
                if(OCR1A == PULSE_INIT) OCR1A = PULSE_120; // 모터 1: 0도 -> 120도
                else OCR1A = PULSE_INIT; // 모터 1: 120도 -> 0도

                if(OCR1B == PULSE_INIT) OCR1B = PULSE_45; // 모터 2: 0도 -> 45도
                else OCR1B = PULSE_INIT; // 모터 2: 45도 -> 0도

                while(!(PINH & (1 << PH5))); // 버튼이 눌린 상태 해제 대기
            }
        }

        _delay_ms(50); //한번 진행한 후 잠시 딜레이
    }

    return 0;
}
